<!DOCTYPE html>
<html>
<head>
    <title>Live Urdu ‚Üí English Translation</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        body {
            background: #eef1f5;
            font-family: "Segoe UI", sans-serif;
        }

        .title {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
        }

        .card-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
        }

        #editor {
            height: 350px;
            background: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: inset 0 0 4px rgba(0,0,0,0.08);
        }

        textarea {
            resize: none;
            font-size: 15px;
        }

        .send-btn {
            background: #0d6efd;
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }

        .highlight-green {
            background-color: #c8f7c5 !important;
            color: #0a5305 !important;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #444;
        }
    </style>

</head>

<body class="p-4">

<div class="container">

    <!-- HEADER AREA (Left aligned buttons) -->
    <div class="d-flex align-items-center gap-3 mb-3">
        <div class="title">üé§ Live Urdu ‚Üí English Translation</div>

        <button id="startBtn" class="btn btn-success">Start</button>
        <button id="stopBtn" class="btn btn-danger">Stop</button>
        <button id="saveBtn" class="btn btn-primary">Save</button>
    </div>

    <!-- Urdu & English Boxes -->
    <div class="row mb-4">

        <div class="col-md-6">
            <div class="section-title">Urdu</div>
            <textarea id="urduBox" class="form-control card-box" rows="5"></textarea>
        </div>

        <div class="col-md-6">
            <div class="section-title">English</div>
            <textarea id="englishBox" class="form-control card-box" rows="5"></textarea>
        </div>

    </div>

    <!-- Editor + Send Box SIDE BY SIDE -->
    <div class="row mb-4">

        <div class="col-md-8">
            <div class="section-title">Editor</div>
            <div class="card-box mb-4">
                <div id="toolbar" class="mb-2">
                    <button class="ql-bold"></button>
                    <button class="ql-italic"></button>
                    <button class="ql-underline"></button>
                </div>
                <div id="editor"></div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="section-title">Send Box</div>
            <textarea id="sendBox" class="form-control card-box" rows="17"></textarea>
        </div>

    </div>

</div>


<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<script>
window.onload = function () {

    /* ---------------------------------------------
      1Ô∏è‚É£ REGISTER SEND BUTTON BLOT
    --------------------------------------------- */
    const Embed = Quill.import('blots/embed');

    class SendBlot extends Embed {
        static create(value) {
            let node = super.create();
            node.innerHTML = `<span class="send-btn" data-text="${value}">Send</span>`;
            return node;
        }
        static value(node) {
            return node.getAttribute("data-text");
        }
    }

    SendBlot.tagName = 'span';
    SendBlot.blotName = 'sendButton';
    Quill.register(SendBlot);





    /* ---------------------------------------------
      3Ô∏è‚É£ INITIALIZE QUILL
    --------------------------------------------- */
    const quill = new Quill("#editor", {
        theme: "snow",
        modules: { toolbar: "#toolbar" }
    });


    /* ---------------------------------------------
      4Ô∏è‚É£ CLICK ON SEND BUTTON
    --------------------------------------------- */
    document.addEventListener("click", function (event) {

        if (!event.target.classList.contains("send-btn")) return;

        let sendSpan = event.target;

        // ‚ùå If already clicked once ‚Üí prevent duplicate sending
        if (sendSpan.getAttribute("data-sent") === "true") return;

        let sendP = sendSpan.closest("p");
        if (!sendP) return;

        let prevP = sendP.previousElementSibling;
        if (!prevP) return;

        // Extract English Text
        let html = prevP.innerHTML;
        let match = html.match(/English:\s*(.*?)(<br>|$)/);
        let englishText = match ? match[1].trim() : "";


        // Append to SendBox instead of replacing
        let box = document.getElementById("sendBox");
        if (box.value.trim() === "") {
            box.value = englishText;
        } else {
            box.value += "\n" + englishText;
        }

        // üî• HIGHLIGHT THE EXACT ENGLISH TEXT IN THIS PARAGRAPH
        // Wrap only the English text with a green highlight span
        if (englishText) {
            let highlighted = html.replace(
                englishText,
                `<span class="highlight-green">${englishText}</span>`
            );

            // Update that exact paragraph ONLY
            prevP.innerHTML = highlighted;
        }

        //  ‚úÖ DISABLE THIS SEND BUTTON FOREVER
        sendSpan.style.opacity = "0.4";
        sendSpan.style.pointerEvents = "none";
        sendSpan.textContent = "Sent";
        sendSpan.setAttribute("data-sent", "true");

    });




    /* ---------------------------------------------
      5Ô∏è‚É£ INSERT NEW TRANSLATION + SEND BUTTON
    --------------------------------------------- */
    setInterval(() => {
        axios.get("/get_latest").then(res => {

            let urdu = res.data.urdu;
            let english = res.data.english;

            if (!urdu.trim()) return;

            urduBox.value = urdu;
            englishBox.value = english;

            quill.insertText(quill.getLength(), `Urdu: ${urdu}\n`);
            quill.insertText(quill.getLength(), `English: ${english} `);

            quill.insertEmbed(quill.getLength(), 'sendButton', english);

            quill.insertText(quill.getLength(), "\n\n");
        });
    }, 1000);


    /* ---------------------------------------------
      6Ô∏è‚É£ SAVE TO DATABASE
    --------------------------------------------- */
    saveBtn.onclick = () => {
        axios.post("/save", { editor: quill.root.innerHTML })
            .then(() => alert("Saved"))
            .catch(() => alert("Save failed"));
    };

    startBtn.onclick = () => {
    axios.get("/start");

    // Disable start button after click
    startBtn.disabled = true;
    startBtn.style.opacity = "0.5";
    startBtn.textContent = "Listening...";
};

    stopBtn.onclick = () => axios.get("/stop");

};
</script>

</body>
</html>
